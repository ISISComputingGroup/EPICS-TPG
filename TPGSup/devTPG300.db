record(bo, "$(P)DISABLE") 
{
    field(DESC, "Disable comms")
    field(PINI, "YES")
    field(VAL, "$(DISABLE=0)")
    field(OMSL, "supervisory")
    field(ZNAM, "COMMS ENABLED")
    field(ONAM, "COMMS DISABLED")
}

## SIMULATION STUFF ##

record(bo, "$(P)SIM") 
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZNAM, "NO")
    field(ONAM, "YES")
	field(VAL, "$(RECSIM=0)")	
}

alias("$(P)SIM", "$(P)SIM:SP")

record(ai, "$(P)SIM:PRESSURE") 
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(PREC, "3")
    field(VAL, "1e-6")
}

## END SIMULATION STUFF ##

record(mbbi, "$(P)UNITS") 
{
    field(DESC, "Units readback")
    field(SCAN, "1 second")
    field(DTYP, "stream")
    field(INP,  "@devTPG300.proto getUnits $(PORT)")
    field(ZRST, "mbar")
    field(ONST, "Torr")
    field(TWST, "Pa")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:UNITS")
    field(SDIS, "$(P)DISABLE")
    info(INTEREST, "HIGH")
}

record(mbbo, "$(P)UNITS:SP:RBV") 
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(OUT,  "$(P)UNITS:SP")
    field(ZRST, "mbar")
    field(ONST, "Torr")
    field(TWST, "Pa")
    field(FLNK, "$(P)UNITS:SP")
}

record(mbbo, "$(P)UNITS:SP") 
{
    field(DESC, "Units setpoint")
    field(SCAN, "Passive")
    field(DTYP, "stream")
    field(OUT,  "@devTPG300.proto setUnits $(PORT)")
    field(ZRST, "mbar")
    field(ONST, "Torr")
    field(TWST, "Pa")
    field(FLNK, "$(P)UNITS")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:UNITS:SP")
    field(SDIS, "$(P)DISABLE")
}

record(mbbo, "$(P)FUNCTION")
{
    field(DESC, "Switching function selection")
    field(SCAN, "Passive")
    field(VAL, "0")
    field(ZRST, "1")
    field(ONST, "2")
    field(TWST, "3")
    field(THST, "4")
    field(FRST, "A")
    field(FVST, "B")
    field(FLNK, "$(P)FUNCTION:RB:FAN")
}

record(fanout, "$(P)FUNCTION:RB:FAN")
{
    field(DESC, "Fanout for all function readbacks")
    field(SCAN, "Passive")
    field(LNK1, "$(P)FUNCTION:SEL:RB")
    field(LNK2, "$(P)FUNCTION:1:RB")
    field(LNK3, "$(P)FUNCTION:2:RB")
    field(LNK4, "$(P)FUNCTION:3:RB")
    field(LNK5, "$(P)FUNCTION:4:RB")
    field(LNK6, "$(P)FUNCTION:A:RB")
    field(LNK7, "$(P)FUNCTION:B:RB")
}

record(stringin, "$(P)FUNCTION:SEL:RB")
{
    field(DESC, "Selected function readback")
    field(DTYP, "stream")
    field(SCAN, "Passive")
    field(PINI, "YES")
    field(INP, "@devTPG300.proto getFunction($(P)FUNCTION.VAL) $(PORT)")
    field(FLNK, "$(P)FUNCTION:SEL:RB:FAN")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:FUNCTION:SEL:RB")
    field(SDIS, "$(P)DISABLE")
}

record(ai, "$(P)FUNCTION:LOW:SP")
{
    field(DESC, "Setpoint for function's low threshold")
    field(SCAN, "Passive")
    field(PREC, "1")
    field(LOPR, "0")
    field(HOPR, "9.9")
    field(FLNK, "$(P)FUNCTION:LOW:SP:CALC")
}

record(calc, "$(P)FUNCTION:LOW:SP:CALC")
{
    field(SCAN, "Passive")
    field(PREC, "1")
    field(INPA, "$(P)FUNCTION:LOW:SP")
    field(INPB, "$(P)FUNCTION:LOW:SP.LOPR")
    field(INPC, "$(P)FUNCTION:LOW:SP.HOPR")
    field(INPD, "$(P)FUNCTION:LOW:SP.PREC")
    field(CALC, "FLOOR(D*10*MIN(MAX(A,B),C))/(D*10)")
}

record(longin, "$(P)FUNCTION:LOW:E:SP")
{
    field(DESC, "Setpoint for function's low threshold exponent")
    field(SCAN, "Passive")
    field(LOPR, "-99")
    field(HOPR, "99")
    field(FLNK, "$(P)FUNCTION:LOW:E:SP:CALC")
}

record(calc, "$(P)FUNCTION:LOW:E:SP:CALC")
{
    field(SCAN, "Passive")
    field(INPA, "$(P)FUNCTION:LOW:E:SP")
    field(INPB, "$(P)FUNCTION:LOW:E:SP.LOPR")
    field(INPC, "$(P)FUNCTION:LOW:E:SP.HOPR")
    field(CALC, "MIN(MAX(A,B),C)")
}

record(ai, "$(P)FUNCTION:HIGH:SP")
{
    field(DESC, "Setpoint for function's high threshold")
    field(SCAN, "Passive")
    field(PREC, "1")
    field(LOPR, "0")
    field(HOPR, "9.9")
    field(FLNK, "$(P)FUNCTION:HIGH:SP:CALC")
}

record(calc, "$(P)FUNCTION:HIGH:SP:CALC")
{
    field(SCAN, "Passive")
    field(PREC, "1")
    field(INPA, "$(P)FUNCTION:HIGH:SP")
    field(INPB, "$(P)FUNCTION:HIGH:SP.LOPR")
    field(INPC, "$(P)FUNCTION:HIGH:SP.HOPR")
    field(INPD, "$(P)FUNCTION:HIGH:SP.PREC")
    field(CALC, "FLOOR(D*10*MIN(MAX(A,B),C))/(D*10)")
}

record(longin, "$(P)FUNCTION:HIGH:E:SP")
{
    field(DESC, "Setpoint for function's high threshold exponent")
    field(SCAN, "Passive")
    field(LOPR, "-99")
    field(HOPR, "99")
    field(FLNK, "$(P)FUNCTION:HIGH:E:SP:CALC")
}

record(calc, "$(P)FUNCTION:HIGH:E:SP:CALC")
{
    field(SCAN, "Passive")
    field(INPA, "$(P)FUNCTION:HIGH:E:SP")
    field(INPB, "$(P)FUNCTION:HIGH:E:SP.LOPR")
    field(INPC, "$(P)FUNCTION:HIGH:E:SP.HOPR")
    field(CALC, "MIN(MAX(A,B),C)")
}

record(mbbo, "$(P)FUNCTION:ASSIGN:SP")
{
    field(DESC, "Setpoint for function's circuit assignment")
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZRST, "No assignment")
    field(ONST, "A1")
    field(TWST, "A2")
    field(THST, "B1")
    field(FRST, "B1")
    field(FVST, "A1 self-monitor")
    field(SXST, "A2 self-monitor")
    field(SVST, "B1 self-monitor")
    field(EIST, "B1 self-monitor")
    field(OUT, "$(P)FUNCTION:ASSIGN")
}

record(longin, "$(P)FUNCTION:ASSIGN")
{
    field(SCAN, "Passive")
}

record(stringout, "$(P)FUNCTION:ASSIGN:SP:OUT") 
{
    field(DESC, "Sends new function's settings")
    field(SCAN, "Passive")
    field(DTYP, "stream")
    field(OUT,  "@devTPG300.proto setFunction($(P)FUNCTION,$(P)FUNCTION:LOW:SP:CALC,$(P)FUNCTION:LOW:E:SP:CALC,$(P)FUNCTION:HIGH:SP:CALC,$(P)FUNCTION:HIGH:E:SP:CALC,$(P)FUNCTION:ASSIGN) $(PORT)")
    field(FLNK, "$(P)FUNCTION:RB:FAN")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:FUNCTION:ASSIGN:SP:OUT")
    field(SDIS, "$(P)DISABLE")
}

record(stringin, "$(P)FUNCTION:STATUS:RB")
{
    field(DESC, "Reading all functions' status")
    field(DTYP, "stream")
    field(SCAN, "1 second")
    field(PINI, "YES")
    field(INP, "@devTPG300.proto getFunctionsStatus $(PORT)")
    field(FLNK, "$(P)FUNCTION:STATUS:RB:FAN")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:FUNCTION:STATUS:RB")
    field(SDIS, "$(P)DISABLE")
}

record(fanout, "$(P)FUNCTION:STATUS:RB:FAN")
{
    field(SCAN, "Passive")
    field(LNK1, "$(P)FUNCTION:STATUS:1:RB")
    field(LNK2, "$(P)FUNCTION:STATUS:2:RB")
    field(LNK3, "$(P)FUNCTION:STATUS:3:RB")
    field(LNK4, "$(P)FUNCTION:STATUS:4:RB")
}

record(scalcout, "$(P)FUNCTION:STATUS:1:RB")
{
    field(DESC, "Status of function 1")
    field(SCAN, "Passive")
    field(INAA, "$(P)FUNCTION:STATUS:RB")
    field(CALC, "AA[0,0]")
    info(INTEREST, "HIGH")
}

record(scalcout, "$(P)FUNCTION:STATUS:2:RB")
{
    field(DESC, "Status of function 2")
    field(SCAN, "Passive")
    field(INAA, "$(P)FUNCTION:STATUS:RB")
    field(CALC, "AA[2,2]")
    info(INTEREST, "HIGH")
}

record(scalcout, "$(P)FUNCTION:STATUS:3:RB")
{
    field(DESC, "Status of function 3")
    field(SCAN, "Passive")
    field(INAA, "$(P)FUNCTION:STATUS:RB")
    field(CALC, "AA[4,4]")
    info(INTEREST, "HIGH")
}

record(scalcout, "$(P)FUNCTION:STATUS:4:RB")
{
    field(DESC, "Status of function 4")
    field(SCAN, "Passive")
    field(INAA, "$(P)FUNCTION:STATUS:RB")
    field(CALC, "AA[6,6]")
    info(INTEREST, "HIGH")
}

### SIMULATION RECORDS ###

record(stringout,"$(P)SIM:FUNCTION:ASSIGN:SP:OUT")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
}

record(stringin,"$(P)SIM:FUNCTION:SEL:RB")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
}

record(stringin,"$(P)SIM:FUNCTION:STATUS:RB")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
}

record(mbbi,"$(P)SIM:UNITS")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
}

alias("$(P)SIM:UNITS","$(P)SIM:UNITS:SP")

alias("$(P)SIM:UNITS","$(P)SIM:UNITS:SP:RBV")

