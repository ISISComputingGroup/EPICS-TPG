record(bo, "$(P)DISABLE") 
{
    field(DESC, "Disable comms")
    field(PINI, "YES")
    field(VAL, "$(DISABLE=0)")
    field(OMSL, "supervisory")
    field(ZNAM, "COMMS ENABLED")
    field(ONAM, "COMMS DISABLED")
}

# This record reads both pressure and errors
record(ai,"$(P)1:RAW_PRES")
{
	field(DESC, "Pressure reading from gauge 1 no error")
    field(SCAN, "1 second")
    field(DTYP, "stream")
    field(INP,  "@TPG26x.proto pres($(P),1:ERROR,2:ERROR,2:RAW_PRES) $(PORT)")
	field(PINI, "YES")
	field(PREC, "4")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:1:PRESSURE")
    field(SDIS, "$(P)DISABLE")
	field(FLNK, "$(P)ACTIVITY")
    field(VAL, 0)
	info(archive, "VAL")
}

# This record is set from 1:RAW_PRES
record(mbbi,"$(P)1:ERROR")
{
	field(DESC, "Error from the Gauge 1")
	field(SCAN, "Passive")
	field(ZRST, "No Error")
	field(ZRSV, "NO_ALARM")
    field(ONST, "Underrange")
    field(ONSV, "MINOR")
    field(TWST, "Overrange")
    field(TWSV, "MINOR")
    field(THST, "Sensor error")
    field(THSV, "MAJOR")
    field(FRST, "Sensor off")
    field(FRSV, "MAJOR")
    field(FVST, "No Sensor")
    field(FVSV, "MAJOR")
    field(SXST, "Identification Error")
    field(SXSV, "MAJOR")
    field(UNSV, "MAJOR")
    field(PINI, "YES")
    field(VAL, 0)    
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:1:ERROR")
	info(archive, "VAL")
	info(INTEREST, "MEDIUM")
}

# This record is set from 1:RAW_PRES
record(ai,"$(P)2:RAW_PRES")
{
	field(DESC, "Pressure reading from gauge 2 no error")
    field(SCAN, "Passive")
    field(PREC, "4")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:2:PRESSURE")
    field(PINI, "YES")
    field(VAL, 0)
	info(archive, "VAL")
}

# This record is set from 1:RAW_PRES
record(mbbi,"$(P)2:ERROR")
{
	field(DESC, "Error from the Gauge 2")
	field(SCAN, "Passive")
	field(ZRST, "No Error")
	field(ZRSV, "NO_ALARM")
    field(ONST, "Underrange")
    field(ONSV, "MINOR")
    field(TWST, "Overrange")
    field(TWSV, "MINOR")
    field(THST, "Sensor error")
    field(THSV, "MAJOR")
    field(FRST, "Sensor off")
    field(FRSV, "MAJOR")
    field(FVST, "No Sensor")
    field(FVSV, "MAJOR")
    field(SXST, "Identification Error")
    field(SXSV, "MAJOR")
    field(SVSV, "MAJOR")
    field(EISV, "MAJOR")
    field(NISV, "MAJOR")
    field(TESV, "MAJOR")
    field(ELSV, "MAJOR")
    field(TVSV, "MAJOR")
    field(TTSV, "MAJOR")
    field(FTSV, "MAJOR")
    field(FFSV, "MAJOR")
    field(PINI, "YES")
    field(VAL, 0)
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:2:ERROR")
    info(archive, "VAL")
	info(INTEREST, "MEDIUM")
}

record(calc,"$(P)1:PRESSURE") {
   field(DESC, "Pressure reading from gauge 1")
   field(INPA, "$(P)1:RAW_PRES MS CP")
   field(INPB, "$(P)1:ERROR MS CP")
   
   field(CALC, "A")
   info(archive, "VAL")
   info(INTEREST, "HIGH")
}

record(calc,"$(P)2:PRESSURE") {
   field(DESC, "Pressure reading from gauge 2")
   field(INPA, "$(P)2:RAW_PRES MS CP")
   # For the error state reported
   field(INPB, "$(P)2:ERROR MS CP")
   # For the disconnect error
   field(INPC, "$(P)1:RAW_PRES MS CP")
   
   field(CALC, "A")
   info(archive, "VAL")
   info(INTEREST, "HIGH")
}

record(calc,"$(P)ACTIVITY") {
   field(DESC, "Activity record")
   field(INPA, "$(P)ACTIVITY")
   field(CALC, "A!=0?0:1")
   field(VAL, 0)
   field(PINI, "YES")
}

record(stringout,"$(P)1:UNITS_TRANSFER") {
    field(DESC, "Transfer the units to pressure 1")
	field(DOL, "$(P)UNITS.VAL CP")
	field(OMSL, "closed_loop")
    field(OUT, "$(P)1:PRESSURE.EGU")
}

record(stringout,"$(P)2:UNITS_TRANSFER") {
    field(DESC, "Transfer the units to pressure 2")
	field(DOL, "$(P)UNITS.VAL CP")
	field(OMSL, "closed_loop")
    field(OUT, "$(P)2:PRESSURE.EGU")
}

record(mbbi, "$(P)UNITS") 
{
    field(DESC, "Units of pressure")
    field(SCAN, "1 second")
    field(DTYP, "stream")
    field(INP,  "@TPG26x.proto getUnits $(PORT)")
    field(ZRST, "mbar")
    field(ONST, "Torr")
    field(TWST, "Pa")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:UNITS")
    field(SDIS, "$(P)DISABLE")
	info(archive, "VAL")
	info(INTEREST, "HIGH")
}

record(mbbo, "$(P)UNITS:SP") 
{
    field(DTYP, "stream")
    field(DESC, "Set the units of pressure")
    field(OUT,  "@TPG26x.proto setUnits $(PORT)")
    field(ZRST, "mbar")
    field(ONST, "Torr")
    field(TWST, "Pa")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:UNITS:SP")
    field(SDIS, "$(P)DISABLE")
	info(archive, "VAL")
}

alias("$(P)UNITS", "$(P)UNITS:SP:RBV")


## SIMULATION STUFF ##

record(bo, "$(P)SIM") 
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZNAM, "NO")
    field(ONAM, "YES")
	field(VAL, "$(RECSIM=0)")
}

alias("$(P)SIM", "$(P)SIM:SP")

record(mbbi, "$(P)SIM:UNITS") 
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZRST, "mbar")
    field(ONST, "Torr")
    field(TWST, "Pa")
}

alias("$(P)SIM:UNITS","$(P)SIM:UNITS:SP")

alias("$(P)SIM:UNITS","$(P)SIM:UNITS:SP:RBV")

record(ai,"$(P)SIM:1:PRESSURE")
{
	field(DESC, "Sim pressure from gauge 1 no error")
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(PINI, "YES")
    field(VAL, 0)
}

record(ai,"$(P)SIM:2:PRESSURE")
{
	field(DESC, "Sim pressure from gauge 2 no error")
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(FLNK, "$(P)2:RAW_PRES")
    field(PINI, "YES")
    field(VAL, 0)
}

record(mbbi,"$(P)SIM:1:ERROR")
{
	field(DESC, "Simulated error from the Gauge 1")
	field(SCAN, "Passive")
	field(ZRST, "No Error")
    field(ONST, "Underrange")
    field(TWST, "Overrange")
    field(THST, "Sensor error")
    field(FRST, "Sensor off")
    field(FVST, "No Sensor")
    field(SXST, "Identification Error")
    field(FLNK, "$(P)1:ERROR")
    field(PINI, "YES")
    field(VAL, 0)
}

record(mbbi,"$(P)SIM:2:ERROR")
{
	field(DESC, "Simulated error from the Gauge 2")
	field(SCAN, "Passive")
	field(ZRST, "No Error")
    field(ONST, "Underrange")
    field(TWST, "Overrange")
    field(THST, "Sensor error")
    field(FRST, "Sensor off")
    field(FVST, "No Sensor")
    field(SXST, "Identification Error")
    field(PINI, "YES")
    field(VAL, 0)
    field(FLNK, "$(P)2:ERROR")
}
