Terminator = '\r\n';
ReplyTimeout = 2000;

#How TPG300 comms work:
#First send a command (e.g. ask for the pressure) then the device will return ACK.
#Then send ENQ to get the actual value.

#According to the streamdevice manual, once an "out" is sent access to the
#device is exclusively locked until the WHOLE protocol is finished.
#This should mean that we do not need to worry about commands interrupting each other

getPressure {
    out "\$1";
    in ACK;
	out ENQ;
    in "%*d,%f";
}

getUnits {
    out "UNI";
	in ACK;
	out ENQ;
    in "%{1|2|3}";
}

setUnits {
    #UNI,1 = mbar
    #UNI,2 = Torr
    #UNI,3 = Pa
    out "UNI,%{1|2|3}";
	in ACK;
	out ENQ;
    in "%{1|2|3}";
}

getFunction {
    out "SP\$1";
    in ACK;
    out ENQ;
    in "%(\$2:LOW:SP:RBV)E,%(\$2:HIGH:SP:RBV)E,%(\$2:ASSIGN:SP:RBV)s";
}

getFunctionMacro {
    out "SP%(\$1)s";
    in ACK;
    out ENQ;
    in "%(\$2:LOW:SP:RBV)E,%(\$2:HIGH:SP:RBV)E,%(\$2:ASSIGN:SP:RBV)s";
}

setFunction {
    out "SP%(\$1)s,%(\$1\$2).1fE%(\$1\$3)d,%(\$1\$4).1fE%(\$1\$5)d,%(\$1\$6)d";
    in ACK;
    out ENQ;
    in "%s";
}

getFunctionsStatus {
    out "SPS";
    in ACK;
    out ENQ;
    in "%(\$1:1:RB){0|1},%(\$1:2:RB){0|1},%(\$1:3:RB){0|1},%(\$1:4:RB){0|1},%*{0|1},%*{0|1}";
}
